<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Page</title>
</head>
<script>
window.onload = function(){ 
    class MessageBroker{
        constructor(){
            this.table = new Map();
        }

        publish(responseId, data){
            if(this.table.has(responseId)){
                const subscriber = this.table.get(responseId);
                subscriber(data);
            }
        }
        subscribe(key, subscriber){
            this.table.set(key,subscriber);
        }
    }

    const Broker = new MessageBroker();

    window.addEventListener("message",function(event){
        if(event.data.responseId != undefined){
            Broker.publish(event.data.responseId, event.data.user);
        }
    });

    const ecount = {
        popup : function(url, name, option){
            return new Promise(function(resolve, reject){
                const responseId = Date.now().toString();   // 키값:타임스탬프
                /*
                Broker.subscribe(responseId, function(message){
                    if(message.errCode)
                    reject(message);
                    else
                    resolve(message);
                })
                */
                Broker.subscribe(responseId, resolve);
                let popup_register = window.open(`${url}?responseId=${responseId}`, name, option);
                popup_register.addEventListener('load', () => {
                    popup_register.addEventListener('unload', () => {
                    newbtn.disabled = false;
                    })
                })
            });
        }
    };

    let newbtn = document.getElementById("newbtn");
    if(newbtn!=null){
        newbtn.onclick= async function(){
            newbtn.disabled = true;
            const message = await ecount.popup("/register","newbtnpopup","width:400, height:400");
            const welcome = message.id+"님 환영합니다.\n회사코드 : " + message.comcode + "\n권한 : "+message.permission+"\n마지막 로그인 시각 : "+message.logdate;
            alert(welcome);
        }
    }

    let listbtn = document.getElementById("listbtn");
    if(listbtn!=null){
        listbtn.onclick = function(){
            var child = window.open('/list', "listbtnpopup","width:400, height:400");
            listbtn.disabled = true;
            child.addEventListener('load', () => {
                child.addEventListener('unload', () => {
                listbtn.disabled = false;
                })
            })
        }
    }

    let alertbtn = document.getElementById("alertbtn");
    if(alertbtn!=null){
        alertbtn.onclick = function(){
            alert("Read권한이 필요합니다.");
        }
    }
};
</script>
<body>
    <h1>Main Page</h1><br>
    <% if(write) {%>
        <p>신규회원 등록하기</p>
        <h5 style="margin-top: 0;">(신규회원 등록은 Write 권한이 있는 사용자만 가능합니다.)</h5>
        <button id="newbtn">신규버튼</button><br>
        <br>
    <% } %>
    <% if(read) {%>
        <p>User List 조회하기 </p>
        <h5 style="margin-top: 0;">(User List 조회는 Read 권한이 있는 사용자만 가능합니다.)</h5>
        <button id="listbtn">목록버튼</button><br>
    <% } %>
    <% if(!read) {%>
        <p>User List 조회하기 </p>
        <h5 style="margin-top: 0;">(User List 조회는 Read 권한이 있는 사용자만 가능합니다.)</h5>
        <button id="alertbtn">목록버튼</button><br>
    <% } %>
</body>
</html>